<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Toolbox Form Submitted</title>
  <link rel="icon" type="image/png" href="./images/logo_gpha.png">
  <link rel="stylesheet" href="./dashboard.css">
  <link rel="stylesheet" href="./user-greeting.css">
  <link rel="stylesheet" href="./adminDashboard.css">
  <style>
    /* Toolbox Submitted Page Styling */
    .submission-success {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      border: 2px solid #27ae60;
      border-radius: 12px;
      padding: 30px;
      margin: 20px auto;
      max-width: 800px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(39, 174, 96, 0.2);
    }

    .submission-success h2 {
      color: #155724;
      margin-bottom: 20px;
      font-size: 28px;
    }

    .submission-details {
      background: white;
      border-radius: 8px;
      padding: 25px;
      margin: 20px auto;
      max-width: 800px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .submission-details h3 {
      color: #2c3e50;
      border-bottom: 2px solid #ecf0f1;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
    }

    .detail-item label {
      font-weight: 600;
      color: #34495e;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .detail-item span {
      color: #2c3e50;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 4px;
      border: 1px solid #e9ecef;
      font-size: 14px;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin: 30px 0;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .btn-success {
      background: #27ae60;
      color: white;
    }

    .btn-success:hover {
      background: #229954;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn-secondary:hover {
      background: #7f8c8d;
      transform: translateY(-2px);
    }

    /* Toolbox Table Styling */
    .toolbox-table-section {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .table-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    /* Status Badge Styling */
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .status-draft {
      background-color: #f0f3f5;
      color: #343a40;
    }

    .status-completed {
      background-color: #d4edda;
      color: #155724;
    }

    /* Action Button Styling */
    .btn-edit,
    .btn-save,
    .btn-delete {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
      transition: background-color 0.3s ease;
    }

    .btn-edit {
      background-color: #3498db;
      color: white;
    }

    .btn-edit:hover {
      background-color: #2980b9;
    }

    .btn-save {
      background-color: #27ae60;
      color: white;
    }

    .btn-save:hover {
      background-color: #229954;
    }

    .btn-delete {
      background-color: #e74c3c;
      color: white;
    }

    .btn-delete:hover {
      background-color: #c0392b;
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 16px;
      background: #95a5a6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .pagination button:hover:not(:disabled) {
      background: #7f8c8d;
    }

    .pagination button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      color: #7f8c8d;
    }

    .pagination span {
      color: #2c3e50;
      font-weight: 600;
    }

    /* Responsive Design */
    @media (max-width: 768px) {

      .submission-success,
      .submission-details,
      .toolbox-table-section {
        margin: 10px;
        padding: 15px;
      }

      .detail-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
        align-items: center;
      }

      .table-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .table-controls input,
      .table-controls select,
      .table-controls button {
        width: 100%;
        margin-bottom: 10px;
      }

      #toolboxTable th,
      #toolboxTable td {
        padding: 8px;
        font-size: 14px;
      }

      .btn-edit,
      .btn-save,
      .btn-delete {
        padding: 4px 8px;
        font-size: 11px;
        margin: 2px;
      }
    }

    /* Loading and Empty States */
    .table-loading {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
    }

    .table-empty {
      text-align: center;
      padding: 40px;
      color: #95a5a6;
    }

    /* Tooltip for truncated text */
    .truncate-text {
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: help;
    }

    .truncate-text:hover {
      white-space: normal;
      word-wrap: break-word;
      max-width: 300px;
      position: relative;
      z-index: 1000;
      background: white;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <div class="container">
    <aside class="sidebar">
      <img src="./images/logo_gpha.png" alt="User Avatar" class="avatar">

      <nav>
        <a href="./dashboard.html">üìä Dashboard</a>
        <a href="./generate_report.html">üìÑ Generate Report</a>
        <a href="./tool_box.html">üõ†Ô∏è Toolbox</a>
        <a href="./inventory.html">üì¶ Inventory</a>
        <a href="./settings.html">‚öôÔ∏è Settings</a>
        <a href="./profile.html">üë§ Profile</a>
        <a href="./index.html">üö™ Logout</a>
      </nav>
    </aside>

    <main class="main-content">




      <!-- Toolbox Table Section -->
      <div class="toolbox-table-section">

        <h1 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">üìã My Toolbox Forms</h1>

        <!-- Search and Filter Controls -->
        <div class="table-controls">

          <input type="text" id="searchToolbox"
            placeholder="Search by activity, location, company, tools, or personnel..."
            style="flex: 1; min-width: 250px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">

          <select id="statusFilter" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">All Status</option>
            <option value="draft">Draft</option>
            <option value="completed">Completed</option>
          </select>


        </div>

        <!-- Toolbox Table -->
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Work Activity</th>
                <th>Date</th>
                <th>Work Location</th>
                <th>Name/Company</th>
                <th>Tools Used</th>
                <th>Prepared By</th>
                <th>Verified By</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="toolboxTableBody">
              <tr>
                <td colspan="8" style="padding: 40px; text-align: center; color: #7f8c8d;">
                  <div style="font-size: 16px;">üìã Loading toolbox forms...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <button id="prevPage" onclick="changePage(-1)" disabled>
            ‚Üê Previous
          </button>
          <span id="pageInfo">Page 1 of 1</span>
          <button id="nextPage" onclick="changePage(1)" disabled>
            Next ‚Üí
          </button>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    // Toolbox Table Functionality
    let allToolboxes = [];
    let filteredToolboxes = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let editingToolboxId = null;

    // Helper function to get toolbox ID (handles different ID field names)
    function getToolboxId(toolbox) {
      return toolbox.id || toolbox._id || toolbox.toolboxId;
    }



    // Load toolbox data on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await loadToolboxData();
      setupSearchAndFilter();
      initializeSocketConnection();
    });

    // Initialize Socket.IO connection for real-time updates
    function initializeSocketConnection() {
      try {
        const socket = io('http://localhost:5000', { transports: ['websocket', 'polling'] });

        socket.on('connect', () => {
          console.log('üîå Connected to real-time toolbox updates');
        });

        socket.on('disconnect', () => {
          console.log('üîå Disconnected from real-time toolbox updates');
        });

        // Listen for toolbox events
        socket.on('toolbox:created', (data) => {
          console.log('üõ†Ô∏è Toolbox created successfully');
          refreshToolboxTable();
        });

        socket.on('toolbox:updated', (data) => {
          console.log('üõ†Ô∏è Toolbox updated successfully');
          refreshToolboxTable();
        });

        socket.on('toolbox:deleted', (data) => {
          console.log('üõ†Ô∏è Toolbox deleted successfully');
          refreshToolboxTable();
        });

      } catch (e) {
        console.warn('Real-time updates unavailable', e);
      }
    }

    // Load toolbox data from API
    async function loadToolboxData() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          console.error('‚ùå Authentication required');
          return;
        }

        const response = await fetch('http://localhost:5000/api/toolbox', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          allToolboxes = await response.json();
          filteredToolboxes = [...allToolboxes];
          updateToolboxTable();
          updatePagination();
        } else {
          throw new Error('Failed to load toolbox data');
        }
      } catch (error) {
        console.error('Error loading toolbox data:', error);
      }
    }

    // Setup search and filter functionality
    function setupSearchAndFilter() {
      const searchInput = document.getElementById('searchToolbox');
      const statusFilter = document.getElementById('statusFilter');

      searchInput.addEventListener('input', filterToolboxes);
      statusFilter.addEventListener('change', filterToolboxes);
    }

    // Filter toolboxes based on search and status
    function filterToolboxes() {
      const searchTerm = document.getElementById('searchToolbox').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;

      filteredToolboxes = allToolboxes.filter(toolbox => {
        const matchesSearch =
          (toolbox.workActivity && toolbox.workActivity.toLowerCase().includes(searchTerm)) ||
          (toolbox.workLocation && toolbox.workLocation.toLowerCase().includes(searchTerm)) ||
          (toolbox.nameCompany && toolbox.nameCompany.toLowerCase().includes(searchTerm)) ||
          (toolbox.toolsUsed && toolbox.toolsUsed.toLowerCase().includes(searchTerm)) ||
          (toolbox.preparedBy && toolbox.preparedBy.toLowerCase().includes(searchTerm)) ||
          (toolbox.verifiedBy && toolbox.verifiedBy.toLowerCase().includes(searchTerm));

        const matchesStatus = !statusFilter || toolbox.status === statusFilter;

        return matchesSearch && matchesStatus;
      });

      currentPage = 1;
      updateToolboxTable();
      updatePagination();
    }

    // Update toolbox table display
    function updateToolboxTable() {
      const tbody = document.getElementById('toolboxTableBody');
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageItems = filteredToolboxes.slice(startIndex, endIndex);

      tbody.innerHTML = '';

      if (pageItems.length === 0) {
        tbody.innerHTML = `
            <tr>
              <td colspan="8" style="padding: 40px; text-align: center; color: #7f8c8d;">
                <div style="font-size: 16px;">üìã No toolbox forms found</div>
              </td>
            </tr>
          `;
        return;
      }

      pageItems.forEach(toolbox => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
              <div class="truncate-text" title="${toolbox.workActivity || 'N/A'}">
                ${toolbox.workActivity || 'N/A'}
              </div>
            </td>
            <td>${formatDate(toolbox.date)}</td>
            <td>
              <div class="truncate-text" title="${toolbox.workLocation || 'N/A'}">
                ${toolbox.workLocation || 'N/A'}
              </div>
            </td>
            <td>
              <div class="truncate-text" title="${toolbox.nameCompany || 'N/A'}">
                ${toolbox.nameCompany || 'N/A'}
              </div>
            </td>
            <td>
              <div class="truncate-text" title="${toolbox.toolsUsed || 'N/A'}">
                ${toolbox.toolsUsed || 'N/A'}
              </div>
            </td>
            <td>
              <div class="truncate-text" title="${toolbox.preparedBy || 'N/A'}">
                ${toolbox.preparedBy || 'N/A'}
              </div>
            </td>
            <td>
              <div class="truncate-text" title="${toolbox.verifiedBy || 'N/A'}">
                ${toolbox.verifiedBy || 'N/A'}
              </div>
            </td>
            <td>
              ${getActionButtons(toolbox)}
            </td>
          `;
        tbody.appendChild(row);
      });
    }

    // Get action buttons based on toolbox status and edit mode
    function getActionButtons(toolbox) {
      const toolboxId = getToolboxId(toolbox);

      if (editingToolboxId === toolboxId) {
        // Edit mode - show save and delete buttons
        return `
          <button onclick="saveToolboxEdit('${toolboxId}')" class="btn-save">
            üíæ Save
          </button>
          <button onclick="deleteToolbox('${toolboxId}')" class="btn-delete">
            üóëÔ∏è Delete
          </button>
        `;
      } else if (toolbox.status === 'completed') {
        // Completed - show completed status
        return `
          <span style="color: #27ae60; font-weight: bold;">‚úÖ Completed</span>
        `;
      } else {
        // Default - show edit button
        return `
          <button onclick="editToolbox('${toolboxId}')" class="btn-edit">
            ‚úèÔ∏è Edit
          </button>
        `;
      }
    }

    // Get status class for styling
    function getStatusClass(status) {
      switch (status) {
        case 'completed':
          return 'status-completed';
        case 'draft':
          return 'status-draft';
        default:
          return 'status-draft';
      }
    }

    // Format date for display
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      return new Date(dateString).toLocaleDateString();
    }

    // Edit toolbox form
    function editToolbox(toolboxId) {
      const toolbox = allToolboxes.find(t => getToolboxId(t) === toolboxId);
      if (!toolbox) return;

      editingToolboxId = toolboxId;

      // Redirect to toolbox form page with edit data
      const editData = encodeURIComponent(JSON.stringify(toolbox));
      window.location.href = `./tool_box.html?edit=${toolboxId}&data=${editData}`;
    }

    // Save toolbox edit
    async function saveToolboxEdit(toolboxId) {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('‚ùå Authentication required');
          return;
        }

        // Get form data from the current page (if available)
        const formData = {
          status: 'completed'
        };

        const response = await fetch(`http://localhost:5000/api/toolbox/${toolboxId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(formData)
        });

        if (response.ok) {
          // Update local data
          const updatedToolbox = allToolboxes.find(t => getToolboxId(t) === toolboxId);
          if (updatedToolbox) {
            updatedToolbox.status = 'completed';
          }

          // Reset edit mode
          editingToolboxId = null;

          // Refresh table
          await loadToolboxData();

          alert('‚úÖ Toolbox form marked as completed!');
        } else {
          throw new Error('Failed to update toolbox form');
        }
      } catch (error) {
        console.error('Error saving toolbox edit:', error);
        alert('‚ùå Failed to save changes');
      }
    }

    // Delete toolbox
    async function deleteToolbox(toolboxId) {
      if (!confirm('Are you sure you want to delete this toolbox form?')) {
        return;
      }

      try {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('‚ùå Authentication required');
          return;
        }

        const response = await fetch(`http://localhost:5000/api/toolbox/${toolboxId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          // Remove from local data
          allToolboxes = allToolboxes.filter(t => getToolboxId(t) !== toolboxId);
          filteredToolboxes = filteredToolboxes.filter(t => getToolboxId(t) !== toolboxId);

          // Reset edit mode if this was the editing toolbox
          if (editingToolboxId === toolboxId) {
            editingToolboxId = null;
          }

          // Refresh table
          updateToolboxTable();
          updatePagination();

          alert('‚úÖ Toolbox form deleted successfully!');
        } else {
          throw new Error('Failed to delete toolbox form');
        }
      } catch (error) {
        console.error('Error deleting toolbox:', error);
        alert('‚ùå Failed to delete toolbox form');
      }
    }

    // Refresh toolbox table
    function refreshToolboxTable() {
      loadToolboxData();
    }

    // Pagination functions
    function changePage(direction) {
      const maxPage = Math.ceil(filteredToolboxes.length / itemsPerPage);

      if (direction === -1 && currentPage > 1) {
        currentPage--;
      } else if (direction === 1 && currentPage < maxPage) {
        currentPage++;
      }

      updateToolboxTable();
      updatePagination();
    }

    function updatePagination() {
      const maxPage = Math.ceil(filteredToolboxes.length / itemsPerPage);
      const pageInfo = document.getElementById('pageInfo');
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');

      pageInfo.textContent = `Page ${currentPage} of ${maxPage}`;
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === maxPage;
    }
  </script>

  <script src="./dark-mode.js"></script>
  <script src="./script.js"></script>
  <script src="./user-greeting.js"></script>
</body>

</html>