<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="icon" type="image/png" href="./images/logo_gpha.png">
  <link rel="stylesheet" href="./dashboard.css">
  <link rel="stylesheet" href="./user-greeting.css">
  <style>
    .search-container {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .search-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .search-btn {
      padding: 10px 20px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .search-btn:hover {
      background: #2980b9;
    }

    .report-actions {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }

    .back-btn {
      padding: 10px 20px;
      background: #2c3e50;
      color: white;
      text-decoration: none;
      border-radius: 4px;
    }

    .back-btn:hover {
      background: #34495e;
    }

    /* Toolbox Form Styling */
    form {
      max-width: 800px;
      margin: 20px auto;
      padding: 30px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    form h3 {
      color: #2c3e50;
      border-bottom: 2px solid #ecf0f1;
      padding-bottom: 10px;
      margin-top: 30px;
      margin-bottom: 20px;
    }

    form h3:first-child {
      margin-top: 0;
    }

    form label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #34495e;
    }

    form input[type="text"],
    form input[type="date"],
    form textarea,
    form select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ecf0f1;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 20px;
      transition: border-color 0.3s ease;
    }

    form input[type="text"]:focus,
    form input[type="date"]:focus,
    form textarea:focus,
    form select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
    }

    form textarea {
      resize: vertical;
      min-height: 80px;
    }

    form button[type="submit"] {
      background: #3498db;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.3s ease;
    }

    form button[type="submit"]:hover {
      background: #2980b9;
    }

    form button[type="submit"]:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }

    /* Edit Mode Styling */
    .header.edit-mode h1 {
      color: #e67e22;
      border-bottom: 2px solid #e67e22;
      padding-bottom: 10px;
    }

    .header.edit-mode h5 {
      color: #e67e22;
      font-style: italic;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      form {
        margin: 10px;
        padding: 20px;
      }

      form input[type="text"],
      form input[type="date"],
      form textarea,
      form select {
        padding: 10px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <aside class="sidebar">
      <img src="./images/logo_gpha.png" alt="User Avatar" class="avatar">

      <nav>
        <a href="./dashboard.html">üìä Dashboard</a>
        <a href="./generate_report.html">üìÑ Generate Report</a>

        <a class="active">üõ†Ô∏è Toolbox</a>
        <a href="./inventory.html">üì¶ Inventory</a>
        <a href="./settings.html">‚öôÔ∏è Settings</a>
        <a href="./profile.html">üë§ Profile</a>
        <a href="./index.html">üö™ Logout</a>
      </nav>
    </aside>

    <main class="main-content">
      <header class="header">
        <h1>TOOLBOX FORM</h1>
        <h5>A Toolbox Form should be conducted prior to every task, whether it is routine or non-routine.</h5>
      </header>

      <!-- Success/Error Message Area -->
      <div id="messageArea"
        style="display: none; margin: 20px auto; max-width: 800px; padding: 15px; border-radius: 6px; text-align: center; font-weight: 600;">
      </div>

      <form id="toolboxForm" action="#" method="post">
        <h3>FACILITY:</h3>
        <label for="workActivity">Work Activity:</label>
        <input type="text" id="workActivity" name="workActivity" required>

        <h3>WORK LOCATION(S)</h3>
        <label for="date">Date:</label>
        <input type="date" id="date" name="date" required>

        <label for="workLocation">Work Location(s):</label>
        <input type="text" id="workLocation" name="workLocation" required>

        <h3>PERSONS ATTENDING BRIEFING</h3>
        <label for="nameCompany">NAME/COMPANY:</label>
        <input type="text" id="nameCompany" name="nameCompany" required>

        <label for="sign">Sign:</label>
        <input type="text" id="sign" name="sign" required>

        <label for="ppeNo">PPE NO:</label>
        <input type="text" id="ppeNo" name="ppeNo" required>

        <label for="toolsUsed">Tools and Equipment to be Used:</label>
        <input type="text" id="toolsUsed" name="toolsUsed" placeholder="Enter tools used" list="tool-list" required>
        <datalist id="tool-list">
          <option value="Set of Rachet">
          <option value="Mallet">
          <option value="Hammer">
          <option value="Box Spanner Set">
          <option value="Master Screw Driver Bit">
          <option value="High Spped Steel Ground Flute Jobber Drill">
          <option value="Precision Eye Loupe">
          <option value="Spanners(10,11,12,13,14,15,16,17,18,19)">
          <option value="Double Cut File Set">
          <option value="Handy Knife for Engineers">
          <option value="Hacksaw blades">
          <option value="Scissors">
          <option value="150mm (6'') Engineer Square">
          <option value="Tape Measure 5m">
          <option value="Tap Wrench Big Size">
          <option value="Tap Wrench Small Size">
          <option value="Tinsnips - General Purpose Straight">
          <option value="Magnetic Telescope Pickup Tool">
          <option value="Heavy Duty Hacksaw">
          <option value="300mm (12'') Engineer Square">
          <option value="Screwdriver Set">
          <option value="Alan Keys Set">
          <option value="Side Cutter">
          <option value="Plier">
          <option value="Long Nose">
          <option value="Shifting Spanner">
          <option value="(Ajustable Wrench) Groove Joint Plier ">
          <option value="Needle File Set">
          <option value="(Pipe Wrench) Locking Plier">
          <option value="Wiring Sharp Blade">
          <option value="Adjustable telescopic inspection mirror">
          <option value="18 Blade Feeler Gauge">
          <option value="Pocket Scriber">
          <option value="Engineers Rule 150mm/6''">
          <option value="Engineers Rule 150mm/12''">
          <option value="Set of Screw Drivers">
          <option value="Chisel">
          <option value="Meter">
          <option value="Battery Tester">
          <option value="Ladder">

        </datalist>

        <label for="hazards">Hazards Identified & Preventive Actions:</label>
        <textarea id="hazards" name="hazards" required></textarea>

        <label for="circulars">Any recent circulars or safety alert on similar issues to be highlighted:</label>
        <textarea id="circulars" name="circulars"></textarea>

        <label for="riskAssessment">Risk Assessment (if any) Ref No:</label>
        <input type="text" id="riskAssessment" name="riskAssessment">

        <label for="permit">Permit to Work (if any) Ref No:</label>
        <input type="text" id="permit" name="permit">

        <label for="remarks">Additional Remarks:</label>
        <textarea id="remarks" name="remarks"></textarea>

        <label for="preparedBy">Prepared By: <br> Name & Signature:</label>
        <input type="text" id="preparedBy" name="preparedBy" required>

        <label for="verifiedBy">Verified By: <br> Duty Officer:</label>
        <input type="text" id="verifiedBy" name="verifiedBy" required>

        <button type="submit" id="submitBtn">Submit</button>

        <div id="editModeButtons" style="display: none; margin-top: 20px; text-align: center;">
          <a href="./toolbox-reports.html"
            style="display: inline-block; padding: 12px 24px; background: #e74c3c; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; transition: background-color 0.3s ease; margin-right: 10px;"
            onmouseover="this.style.background='#c0392b'" onmouseout="this.style.background='#e74c3c'">
            ‚ùå Cancel Edit
          </a>
        </div>

        <div style="margin-top: 20px; text-align: center;">
          <a href="./toolbox-reports.html"
            style="display: inline-block; padding: 12px 24px; background: #2c3e50; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; transition: background-color 0.3s ease;"
            onmouseover="this.style.background='#34495e'" onmouseout="this.style.background='#2c3e50'">
            üìã View All Toolbox Forms
          </a>
        </div>
      </form>

  </div>




  </div>

  <script>
    // Function to show messages
    function showMessage(message, type = 'success') {
      const messageArea = document.getElementById('messageArea');
      messageArea.style.display = 'block';
      messageArea.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
      messageArea.style.color = type === 'success' ? '#155724' : '#721c24';
      messageArea.style.border = `1px solid ${type === 'success' ? '#c3e6cb' : '#f5c6cb'}`;
      messageArea.innerHTML = message; // Use innerHTML to allow HTML tags

      // Auto-hide after 5 seconds
      setTimeout(() => {
        messageArea.style.display = 'none';
      }, 5000);
    }

    // Check if we're in edit mode
    function getEditId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('edit');
    }

    // Load existing toolbox data for editing
    async function loadToolboxForEdit(toolboxId) {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          showMessage('Please login first', 'error');
          return;
        }

        const response = await fetch(`http://localhost:5000/api/toolbox/${toolboxId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const toolbox = await response.json();

          // Populate form fields
          document.getElementById('workActivity').value = toolbox.work_activity || toolbox.workActivity || '';
          document.getElementById('date').value = toolbox.date || '';
          document.getElementById('workLocation').value = toolbox.work_location || toolbox.workLocation || '';
          document.getElementById('nameCompany').value = toolbox.name_company || toolbox.nameCompany || '';
          document.getElementById('sign').value = toolbox.sign || '';
          document.getElementById('ppeNo').value = toolbox.ppe_no || toolbox.ppeNo || '';
          document.getElementById('toolsUsed').value = toolbox.tools_used || toolbox.toolsUsed || '';
          document.getElementById('hazards').value = toolbox.hazards || '';
          document.getElementById('circulars').value = toolbox.circulars || '';
          document.getElementById('riskAssessment').value = toolbox.risk_assessment || toolbox.riskAssessment || '';
          document.getElementById('permit').value = toolbox.permit || '';
          document.getElementById('remarks').value = toolbox.remarks || '';
          document.getElementById('preparedBy').value = toolbox.prepared_by || toolbox.preparedBy || '';
          document.getElementById('verifiedBy').value = toolbox.verified_by || toolbox.verifiedBy || '';

          // Update button text and header
          document.getElementById('submitBtn').textContent = 'Update Toolbox Form';
          document.querySelector('.header h1').textContent = 'EDIT TOOLBOX FORM';
          document.querySelector('.header h5').textContent = 'Update existing toolbox form data';
          document.querySelector('.header').classList.add('edit-mode');

          showMessage('‚úÖ Toolbox form loaded for editing', 'success');
        } else {
          showMessage('‚ùå Failed to load toolbox form for editing', 'error');
        }
      } catch (error) {
        console.error('Error loading toolbox for edit:', error);
        showMessage('‚ùå Error loading toolbox form', 'error');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('toolboxForm');
      if (!form) return;

      // Initialize Socket.IO connection
      initializeSocketConnection();

      // Check if we're in edit mode
      const editId = getEditId();
      if (editId) {
        loadToolboxForEdit(editId);
        document.getElementById('editModeButtons').style.display = 'block'; // Show cancel edit button
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Get form data
        const formData = {
          workActivity: document.getElementById('workActivity').value,
          date: document.getElementById('date').value,
          workLocation: document.getElementById('workLocation').value,
          nameCompany: document.getElementById('nameCompany').value,
          sign: document.getElementById('sign').value,
          ppeNo: document.getElementById('ppeNo').value,
          toolsUsed: document.getElementById('toolsUsed').value,
          hazards: document.getElementById('hazards').value,
          circulars: document.getElementById('circulars').value,
          riskAssessment: document.getElementById('riskAssessment').value,
          permit: document.getElementById('permit').value,
          remarks: document.getElementById('remarks').value,
          preparedBy: document.getElementById('preparedBy').value,
          verifiedBy: document.getElementById('verifiedBy').value
        };

        try {
          const token = localStorage.getItem('token');
          if (!token) {
            showMessage('Please login first', 'error');
            setTimeout(() => {
              window.location.href = './index.html';
            }, 2000);
            return;
          }

          // Show loading state
          const submitBtn = form.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.textContent = editId ? '‚è≥ Updating...' : '‚è≥ Submitting...';
          submitBtn.disabled = true;

          let response;
          if (editId) {
            // Update existing toolbox
            response = await fetch(`http://localhost:5000/api/toolbox/${editId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(formData)
            });
          } else {
            // Create new toolbox
            response = await fetch('http://localhost:5000/api/toolbox', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(formData)
            });
          }

          if (response.ok) {
            const result = await response.json();
            const action = editId ? 'updated' : 'created';
            showMessage(`‚úÖ Toolbox form ${action} successfully! - <a href="./toolbox-reports.html" style="color: #155724; text-decoration: underline;">View All Toolbox Forms</a>`, 'success');

            if (!editId) {
              // Reset form only for new submissions
              form.reset();
              // Set today's date as default
              document.getElementById('date').value = new Date().toISOString().split('T')[0];
            }

          } else {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `Failed to ${editId ? 'update' : 'submit'} form`);
          }
        } catch (err) {
          console.error('Form submission error:', err);
          showMessage(`‚ùå Error: ${err.message}`, 'error');
        } finally {
          // Reset button state
          const submitBtn = form.querySelector('button[type="submit"]');
          submitBtn.textContent = editId ? 'Update Toolbox Form' : 'Submit';
          submitBtn.disabled = false;
        }
      });

      // Set today's date as default (only for new forms)
      if (!editId) {
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
      }
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="./dark-mode.js"></script>
  <script src="./script.js"></script>
  <script src="./toolbox.js"></script>
  <script src="./user-greeting.js"></script>
  <script src="http://localhost:5000/socket.io/socket.io.js"></script>
  <script>
    // Function to show messages
    function showMessage(message, type = 'success') {
      const messageArea = document.getElementById('messageArea');
      messageArea.style.display = 'block';
      messageArea.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
      messageArea.style.color = type === 'success' ? '#155724' : '#721c24';
      messageArea.style.border = `1px solid ${type === 'success' ? '#c3e6cb' : '#f5c6cb'}`;
      messageArea.innerHTML = message; // Use innerHTML to allow HTML tags

      // Auto-hide after 5 seconds
      setTimeout(() => {
        messageArea.style.display = 'none';
      }, 5000);
    }

    // Initialize Socket.IO connection for real-time updates
    function initializeSocketConnection() {
      try {
        const socket = io('http://localhost:5000', { transports: ['websocket', 'polling'] });

        // Listen for real-time toolbox events
        socket.on('connect', () => {
          console.log('üîå Connected to real-time toolbox updates');
        });

        socket.on('disconnect', () => {
          console.log('üîå Disconnected from real-time toolbox updates');
        });

        // Toolbox created event (for confirmation)
        socket.on('tool:created', (data) => {
          console.log('üõ†Ô∏è Toolbox created successfully');
        });

        // Toolbox updated event (for confirmation)
        socket.on('tool:updated', (data) => {
          console.log('üõ†Ô∏è Toolbox updated successfully');
        });

      } catch (e) {
        console.warn('Real-time updates unavailable', e);
      }
    }

    // Check if we're in edit mode
    function getEditId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('edit');
    }

    // Load existing toolbox data for editing
    async function loadToolboxForEdit(toolboxId) {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          showMessage('Please login first', 'error');
          return;
        }

        const response = await fetch(`http://localhost:5000/api/toolbox/${toolboxId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const toolbox = await response.json();

          // Populate form fields
          document.getElementById('workActivity').value = toolbox.work_activity || toolbox.workActivity || '';
          document.getElementById('date').value = toolbox.date || '';
          document.getElementById('workLocation').value = toolbox.work_location || toolbox.workLocation || '';
          document.getElementById('nameCompany').value = toolbox.name_company || toolbox.nameCompany || '';
          document.getElementById('sign').value = toolbox.sign || '';
          document.getElementById('ppeNo').value = toolbox.ppe_no || toolbox.ppeNo || '';
          document.getElementById('toolsUsed').value = toolbox.tools_used || toolbox.toolsUsed || '';
          document.getElementById('hazards').value = toolbox.hazards || '';
          document.getElementById('circulars').value = toolbox.circulars || '';
          document.getElementById('riskAssessment').value = toolbox.risk_assessment || toolbox.riskAssessment || '';
          document.getElementById('permit').value = toolbox.permit || '';
          document.getElementById('remarks').value = toolbox.remarks || '';
          document.getElementById('preparedBy').value = toolbox.prepared_by || toolbox.preparedBy || '';
          document.getElementById('verifiedBy').value = toolbox.verified_by || toolbox.verifiedBy || '';

          // Update button text and header
          document.getElementById('submitBtn').textContent = 'Update Toolbox Form';
          document.querySelector('.header h1').textContent = 'EDIT TOOLBOX FORM';
          document.querySelector('.header h5').textContent = 'Update existing toolbox form data';
          document.querySelector('.header').classList.add('edit-mode');

          showMessage('‚úÖ Toolbox form loaded for editing', 'success');
        } else {
          showMessage('‚ùå Failed to load toolbox form for editing', 'error');
        }
      } catch (error) {
        console.error('Error loading toolbox for edit:', error);
        showMessage('‚ùå Error loading toolbox form', 'error');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('toolboxForm');
      if (!form) return;

      // Check if we're in edit mode
      const editId = getEditId();
      if (editId) {
        loadToolboxForEdit(editId);
        document.getElementById('editModeButtons').style.display = 'block'; // Show cancel edit button
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Get form data
        const formData = {
          workActivity: document.getElementById('workActivity').value,
          date: document.getElementById('date').value,
          workLocation: document.getElementById('workLocation').value,
          nameCompany: document.getElementById('nameCompany').value,
          sign: document.getElementById('sign').value,
          ppeNo: document.getElementById('ppeNo').value,
          toolsUsed: document.getElementById('toolsUsed').value,
          hazards: document.getElementById('hazards').value,
          circulars: document.getElementById('circulars').value,
          riskAssessment: document.getElementById('riskAssessment').value,
          permit: document.getElementById('permit').value,
          remarks: document.getElementById('remarks').value,
          preparedBy: document.getElementById('preparedBy').value,
          verifiedBy: document.getElementById('verifiedBy').value
        };

        try {
          const token = localStorage.getItem('token');
          if (!token) {
            showMessage('Please login first', 'error');
            setTimeout(() => {
              window.location.href = './index.html';
            }, 2000);
            return;
          }

          // Show loading state
          const submitBtn = form.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.textContent = editId ? '‚è≥ Updating...' : '‚è≥ Submitting...';
          submitBtn.disabled = true;

          let response;
          if (editId) {
            // Update existing toolbox
            response = await fetch(`http://localhost:5000/api/toolbox/${editId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(formData)
            });
          } else {
            // Create new toolbox
            response = await fetch('http://localhost:5000/api/toolbox', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(formData)
            });
          }

          if (response.ok) {
            const result = await response.json();
            const action = editId ? 'updated' : 'created';
            showMessage(`‚úÖ Toolbox form ${action} successfully! - <a href="./toolbox-reports.html" style="color: #155724; text-decoration: underline;">View All Toolbox Forms</a>`, 'success');

            if (!editId) {
              // Reset form only for new submissions
              form.reset();
              // Set today's date as default
              document.getElementById('date').value = new Date().toISOString().split('T')[0];
            }

          } else {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `Failed to ${editId ? 'update' : 'submit'} form`);
          }
        } catch (err) {
          console.error('Form submission error:', err);
          showMessage(`‚ùå Error: ${err.message}`, 'error');
        } finally {
          // Reset button state
          const submitBtn = form.querySelector('button[type="submit"]');
          submitBtn.textContent = editId ? 'Update Toolbox Form' : 'Submit';
          submitBtn.disabled = false;
        }
      });

      // Set today's date as default (only for new forms)
      if (!editId) {
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
      }
    });
  </script>
</body>

</html>